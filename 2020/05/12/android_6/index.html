<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="good good study"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>TextView识别文本中的超链接并能点击跳转 | wzmyyj</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">TextView识别文本中的超链接并能点击跳转</h1><a id="logo" href="/.">wzmyyj</a><p class="description">Let life be beautiful like summer flowers.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">TextView识别文本中的超链接并能点击跳转</h1><div class="post-meta"><a href="/2020/05/12/android_6/#comments" class="comment-count"></a><p><span class="date">May 12, 2020</span></p></div><div class="post-content"><h4 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h4><p>如题所诉。需要识别出文本中的链接，并显示成超链接的UI样式。点击能够跳转打开网页（最好是自己app内部的WebView。）</p>
<a id="more"></a>
<h4 id="简单实现："><a href="#简单实现：" class="headerlink" title="简单实现："></a>简单实现：</h4><p>在 xml 里给TextView 设置:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView </span><br><span class="line">    android:<span class="attribute">autoLink</span>=<span class="string">"web"</span></span><br><span class="line">    android:<span class="attribute">linksClickable</span>=<span class="string">"true"</span></span><br><span class="line">    android:<span class="attribute">textColorLink</span>=<span class="string">"@color/color_017EBD"</span></span><br><span class="line"><span class="built_in">..</span>./&gt;</span><br></pre></td></tr></table></figure>
<p> 简单，但是有很大的缺点：</p>
<ol>
<li>链接下的下划线去不掉。</li>
<li>只能跳转到系统默认的浏览器。</li>
<li>链接后面不佳空格有中文就识别不出来。</li>
</ol>
<p>虽然它不好。但它是系统自带的功能，可以看看它的实现原理，可以关键地方改写它。</p>
<h4 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h4><p>根据所学知识。想必也是ClickableSpan的一种实际使用罢了。可以先看看：<a href="https://www.jianshu.com/p/c53e24b715e2" target="_blank" rel="noopener">ClickableSpan的一点点摸索</a> 。</p>
<p><strong>关键类：</strong></p>
<ol>
<li>URLSpan：ClickableSpan的子类，带URL，下划线去不掉。</li>
<li>LinkMovementMethod：ClickableSpan生效所需，之前讲了。</li>
<li>Linkify：一个识别文字中链接，地址，邮箱之类的工具类。</li>
</ol>
<p>前面两个看ClickableSpan那篇就理解了。重点看Linkify。</p>
<h3 id="Linkify："><a href="#Linkify：" class="headerlink" title="Linkify："></a>Linkify：</h3><blockquote>
<p><em>Linkify take a piece of text and a regular expression and turns all of the regex matches in the text into clickable links.  This is particularly useful for matching things like email addresses, web URLs, etc. and making  them actionable.</em></p>
</blockquote>
<p>Linkify是一个辅助类，通过RegEx样式匹配，自动地在TextView类（和继承的类）中创建超链接。</p>
<p>它的方法public方法有多个重载方法。只需要了解它的主要功能。</p>
<p>我们可以用它实现超链接的识别。写个工具类。</p>
<h4 id="工具类："><a href="#工具类：" class="headerlink" title="工具类："></a>工具类：</h4><p>我们只需要自定义RegEx就可以实现我们自己的识别超链接规则：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> HyperLinkHelper &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> const <span class="keyword">val</span> REGEX = <span class="string">"(((http[s]?|ftp?|file?)://)?[a-zA-Z0-9.\\-]+\\.([a-zA-Z]&#123;2,4&#125;)(:\\d+)?(/[a-zA-Z0-9.\\-~!@#$%^&amp;*+?:_/=&lt;&gt;]*)?)|(www.[a-zA-Z0-9.\\-]+\\.([a-zA-Z]&#123;2,4&#125;)(:\\d+)?(/[a-zA-Z0-9.\\-~!@#$%^&amp;*+?:_/=&lt;&gt;]*)?)"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换成链接。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">transUrlSpan</span><span class="params">(text: <span class="type">CharSequence</span>, <span class="meta">@ColorInt</span> highColor: <span class="type">Int</span> = <span class="number">-0xa8946b</span>)</span></span>: Spannable &#123;</span><br><span class="line">        <span class="keyword">val</span> ss = SpannableString.valueOf(text)</span><br><span class="line">        Linkify.addLinks(ss, Pattern.compile(REGEX), <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">val</span> urlSpans = ss.getSpans(<span class="number">0</span>, ss.length,</span><br><span class="line">                URLSpan::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>) ?: <span class="type">return ss</span></span></span><br><span class="line">        <span class="keyword">for</span> (sp <span class="keyword">in</span> urlSpans) &#123;</span><br><span class="line">            <span class="keyword">val</span> start = ss.getSpanStart(sp)</span><br><span class="line">            <span class="keyword">val</span> end = ss.getSpanEnd(sp)</span><br><span class="line">            ss.removeSpan(sp)</span><br><span class="line">            ss.setSpan(UrlLinkSpan(sp.url.formatUrl(), highColor), start, end, Spannable.SPAN_INCLUSIVE_EXCLUSIVE)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ss</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置点击事件。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setClickListener</span><span class="params">(spanned: <span class="type">Spanned</span>, listener: <span class="type">UrlLinkSpan</span>.<span class="type">OnClickListener</span>)</span></span> &#123;</span><br><span class="line">        spanned.getSpans(<span class="number">0</span>, spanned.length, UrlLinkSpan::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">                .forEach &#123; it.listener = listener &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> String.<span class="title">formatUrl</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (indexOf(<span class="string">"http"</span>) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; indexOf(<span class="string">"ftp"</span>) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; indexOf(<span class="string">"file"</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="string">"http://<span class="variable">$this</span>"</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 并把URLSpan替换成样式需要的Span。</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UrlLinkSpan</span></span>(<span class="keyword">val</span> url: String, <span class="meta">@ColorInt</span> <span class="keyword">val</span> highColor: <span class="built_in">Int</span>) : ClickableSpan() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> listener: OnClickListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">interface</span> <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">fun</span> <span class="title">onUrlLinkClick</span><span class="params">(widget: <span class="type">View</span>, url: <span class="type">String</span>)</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(widget: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">            listener?.onUrlLinkClick(widget, url)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateDrawState</span><span class="params">(ds: <span class="type">TextPaint</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.updateDrawState(ds)</span><br><span class="line">            ds.color = highColor</span><br><span class="line">            ds.isUnderlineText = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 整一个 BindingAdapter 方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(value = [<span class="meta-string">"binding_text_url_link"</span>, <span class="meta-string">"binding_url_link_listener"</span>], requireAll = true)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> TextView.<span class="title">setUrlLinkText</span><span class="params">(text: <span class="type">CharSequence</span>?, listener: <span class="type">HyperLinkHelper</span>.<span class="type">UrlLinkSpan</span>.<span class="type">OnClickListener</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.text?.toString() != text) &#123;</span><br><span class="line">        <span class="keyword">this</span>.text = <span class="keyword">if</span> (text != <span class="literal">null</span>) &#123;</span><br><span class="line">            HyperLinkHelper.transUrlSpan(text, getColor(R.color.color_017EBD)).apply &#123;</span><br><span class="line">                HyperLinkHelper.setClickListener(<span class="keyword">this</span>, listener)</span><br><span class="line">                movementMethod = ClickLinkMovementMethod</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ClickLinkMovementMethod 是为了解决长按的问题。<a href="https://www.jianshu.com/p/c53e24b715e2" target="_blank" rel="noopener">ClickableSpan的一点点摸索</a>那篇文章有讲。</p>
<h4 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a>扩展：</h4><p>Linkify还可以定义如下接口：</p>
<ol>
<li><strong>Match Filter：</strong>实现acceptMatch方法，来为RegEx样式匹配添加额外的条件。当一个潜在的匹配发现时，acceptMatch被触发，匹配的开始点和结束点（包括被查找的整个文本）以参数的形式传入。</li>
<li><strong>Transform Filter：</strong>为格式化文本字符串提供更大的自由度，允许你修改由链接文本自动生成的隐式URI。</li>
</ol>
<p>有兴趣自己去了解。</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>要点：</p>
<ol>
<li>正则识别链接</li>
<li>显示样式自定义，去掉下划线。</li>
<li>点击逻辑自定义，跳转到自己的WebView。</li>
<li>解决长按冲突问题。</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/3262738-e71299373be3b0e1.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配一张图"></p>
</div><div class="post-copyright"><blockquote><p>原文作者: wzmyyj</p><p>原文链接: <a href="https://wzmyyj.top/2020/05/12/android_6/">https://wzmyyj.top/2020/05/12/android_6/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/android/">android</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2020/07/19/android_7/" class="pre">IM项目中的自定义小表情实现</a><a href="/2020/05/12/android_5/" class="next">ClickableSpan的一点点摸索</a></div><div id="comments"></div></div></div></div><div class="layout-r hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/21/android_10/">IM中群消息发送者信息刷新方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/21/android_9/">IM中按名称拼音字母分组排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/21/android_8/">IM项目中群成员获取与缓存策略</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/20/story_2/">小故事：未熟的果实</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/19/android_7/">IM项目中的自定义小表情实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/android_6/">TextView识别文本中的超链接并能点击跳转</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/android_5/">ClickableSpan的一点点摸索</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/android_4/">Fragment 监听返回按键</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/10/android_3/">LiveData实现消息总线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/13/kotlin_1/">kotlin使用let报java.lang.NoClassDefFoundError</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/IT/" style="font-size: 15px;">IT</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/kotlin/" style="font-size: 15px;">kotlin</a> <a href="/tags/故事/" style="font-size: 15px;">故事</a> <a href="/tags/图片/" style="font-size: 15px;">图片</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://shiyi.today/" title="李昊昊：诗意" target="_blank">李昊昊：诗意</a><ul></ul><a href="https://wangzeliangbsd.github.io/" title="王亮亮：WZL Blog" target="_blank">王亮亮：WZL Blog</a><ul></ul><a href="https://foreverlf.github.io/" title="方胖子：ForeverLF" target="_blank">方胖子：ForeverLF</a><ul></ul><a href="https://zqhgit.github.io/" title="曾小辉：Sprider" target="_blank">曾小辉：Sprider</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p><span> Copyright &copy;<a href="/." rel="nofollow">wzmyyj.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"superSample":2,"width":100,"height":200,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":false,"scale":0.1},"react":{"opacityDefault":1,"opacityOnHover":0.2}});</script></body></html>