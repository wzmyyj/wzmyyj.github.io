<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="good good study"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>ClickableSpançš„ä¸€ç‚¹ç‚¹æ‘¸ç´¢ | wzmyyj</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ClickableSpançš„ä¸€ç‚¹ç‚¹æ‘¸ç´¢</h1><a id="logo" href="/.">wzmyyj</a><p class="description">Let life be beautiful like summer flowers.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="æœç´¢"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">ClickableSpançš„ä¸€ç‚¹ç‚¹æ‘¸ç´¢</h1><div class="post-meta"><a href="/2020/05/12/android_5/#comments" class="comment-count"></a><p><span class="date">May 12, 2020</span></p></div><div class="post-content"><h2 id="ClickableSpan"><a href="#ClickableSpan" class="headerlink" title="ClickableSpan"></a>ClickableSpan</h2><p>ClickableSpan ç”¨æ¥å®ç° TextViewé‡Œçš„æ–‡å­—å±€éƒ¨çš„é«˜äº®å’Œç‚¹å‡»äº‹ä»¶ã€‚</p>
<a id="more"></a>
<p>ä»‹ç»ï¼š</p>
<blockquote>
<p>If an object of this type is attached to the text of a TextView with a movement method of <strong>LinkMovementMethod</strong>, the affected spans of text can be selected. If selected and clicked, the {@link #<strong>onClick</strong>} method will* be called.</p>
</blockquote>
<p>æ„æ€æ˜¯è¿™ä¸œè¥¿åŠ åˆ°TextViewä¸Šï¼Œå¹¶è®¾ç½®LinkMovementMethodï¼Œå°±å¯ä»¥é€‰æ‹©æˆ–ç‚¹å‡»å¹¶å›è°ƒonClickæ–¹æ³•ã€‚<br>æºç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClickableSpan</span> <span class="keyword">extends</span> <span class="title">CharacterStyle</span> <span class="keyword">implements</span> <span class="title">UpdateAppearance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> sIdCounter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mId = sIdCounter++;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the click action associated with this span.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(@NonNull View widget)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Makes the text underlined and in the link color.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDrawState</span><span class="params">(@NonNull TextPaint ds)</span> </span>&#123;</span><br><span class="line">        ds.setColor(ds.linkColor);</span><br><span class="line">        ds.setUnderlineText(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the unique ID for this span.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The unique ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æºç æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯èƒ½æ”¹å˜æ–‡å­—æ ·å¼çš„åŒæ—¶æœ‰ä¸ªonClickæŠ½è±¡æ–¹æ³•ã€‚</p>
<h4 id="é‡åˆ°é—®é¢˜"><a href="#é‡åˆ°é—®é¢˜" class="headerlink" title="é‡åˆ°é—®é¢˜"></a>é‡åˆ°é—®é¢˜</h4><p><strong>é—®é¢˜ï¼š</strong><br>ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸åœ¨vmå±‚ï¼ˆvmé‡Œæˆ–è€… vmçš„è¾…åŠ©é€»è¾‘ç±»é‡Œï¼‰è®¾ç½®æ•°æ®ï¼ˆæ¯”å¦‚SpannableStringï¼‰ï¼Œå¦‚æœè®¾ç½®çš„æ˜¯ClickableSpanã€‚è®¾ç½®æ ·å¼å¤–ï¼Œè¿˜éœ€è¦å®ç°onClickæ–¹æ³•ï¼Œå³ç‚¹å‡»äº‹ä»¶ã€‚ç„¶è€Œç‚¹å‡»äº‹ä»¶å¾€å¾€æ˜¯UIå±‚çš„é€»è¾‘ã€‚ä¸€èˆ¬ä¸å…è®¸åœ¨vmå±‚å†™ç‚¹å‡»äº‹ä»¶é€»è¾‘ã€‚å‘ vmé‡Œä¼ ç‚¹å‡»äº‹ä»¶ï¼ˆå¾€å¾€æ˜¯å†…éƒ¨ç±»ä¼šæŒæœ‰fragmentï¼‰ï¼Œä¸æ˜¯å¾ˆå¯å–ã€‚<br><strong>ç›®æ ‡ï¼š</strong><br>æˆ‘å¸Œæœ›vmå±‚åªå¯¹æ•°æ®çš„è®¾ç½®ï¼ŒUIå±‚è®¾ç½®ç‚¹å‡»äº‹ä»¶ã€‚</p>
<p><strong>æ–¹æ¡ˆï¼š</strong><br>å®šä¹‰ä¸€ä¸ªå¯ä»¥è®¾ç½®äº‹ä»¶ï¼Œå¹¶æºå¸¦æ•°æ®çš„ ClickableSpanã€‚<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataClickSpan</span></span>(<span class="meta">@ColorInt</span> <span class="keyword">val</span> color: <span class="built_in">Int</span>) : ClickableSpan() &#123;</span><br><span class="line">    <span class="keyword">val</span> map = HashMap&lt;String, Any?&gt;()</span><br><span class="line">    <span class="keyword">var</span> listener: OnClickListener? = <span class="literal">null</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onSpanClick</span><span class="params">(widget: <span class="type">View</span>, map: <span class="type">HashMap</span>&lt;<span class="type">String</span>, Any?&gt;)</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(widget: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">        listener?.onSpanClick(widget, map)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateDrawState</span><span class="params">(ds: <span class="type">TextPaint</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®é¢œè‰²</span></span><br><span class="line">        ds.color = color</span><br><span class="line">        <span class="comment">//å»æ‰ä¸‹åˆ’çº¿</span></span><br><span class="line">        ds.isUnderlineText = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¾ç½®ç‚¹å‡»äº‹ä»¶ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Spanned.<span class="title">setDataClickListener</span><span class="params">(listener: <span class="type">DataClickSpan</span>.<span class="type">OnClickListener</span>?)</span></span> &#123;</span><br><span class="line">    getSpans(<span class="number">0</span>, <span class="keyword">this</span>.length - <span class="number">1</span>, DataClickSpan::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">            .forEach &#123; it.listener = listener &#125;</span><br><span class="line">&#125;</span><br><span class="line">å†æ•´ä¸€ä¸ªBindingAdapteræ–¹æ³•ï¼š</span><br><span class="line"><span class="meta">@BindingAdapter(value = [<span class="meta-string">"binding_spanned_data"</span>, <span class="meta-string">"binding_spanned_clickListener"</span>], requireAll = true)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> TextView.<span class="title">setSpannedClickListenerOfString</span><span class="params">(<span class="keyword">data</span>: <span class="type">Spanned</span>?, listener: <span class="type">DataClickSpan</span>.<span class="type">OnClickListener</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">data</span>?.setDataClickListener(listener)</span><br><span class="line">    movementMethod = ClickLinkMovementMethod<span class="comment">// è¿™ä¸ªæ˜¯è‡ªå®šä¹‰LinkMovementMethod</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>ä½¿ç”¨ï¼š</strong><br>vm å±‚ä½¿ç”¨ï¼Œè®¾ç½®æºå¸¦æ•°æ®ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºå¸¦ imAccount</span></span><br><span class="line"><span class="function"><span class="title">SpannableString</span><span class="params">(<span class="string">"è¿™æ˜¯å¯ä»¥ç‚¹å‡»çš„æ–‡å­—"</span>)</span></span><span class="selector-class">.apply</span> &#123;</span><br><span class="line">                setSpan(DataClickSpan(getColor(R<span class="selector-class">.color</span><span class="selector-class">.color_576B95</span>))</span><br><span class="line">                        <span class="selector-class">.apply</span> &#123; map[IM_ACCOUNT] = joinGroupMsg<span class="selector-class">.inviteImAccount</span> &#125;,</span><br><span class="line">                        <span class="number">1</span>, length - <span class="number">1</span>, Spanned.SPAN_INCLUSIVE_EXCLUSIVE)</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>UI å±‚ä½¿ç”¨ï¼Œè®¾ç½®äº‹ä»¶ï¼Œæ¯”å¦‚è¿™ä¸ªSpannableStringæ˜¯è®¾ç½®å†æŸä¸ªitemçš„TextView ä¸Šã€‚</p>
<ol>
<li>è®©è¿™ä¸ªItemçš„ VHModel çš„OnItemEventListenerç»§æ‰¿DataClickSpan.OnClickListener</li>
<li><p>å†å¸ƒå±€é‡Œè®¾ç½®ï¼š</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">TextView</span> </span></span></span><br><span class="line"><span class="xml">   binding_spanned_clickListener="@</span><span class="template-variable">&#123;listener&#125;</span><span class="xml">"</span></span><br><span class="line"><span class="xml">   binding_spanned_data="@</span><span class="template-variable">&#123;item.removeDesc&#125;</span><span class="xml">"</span></span><br><span class="line"><span class="xml">.../&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨Fragmenté‡Œå®ç°æ¥å£ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSpanClick</span><span class="params">(widget: <span class="type">View</span>, map: <span class="type">HashMap</span>&lt;<span class="type">String</span>, Any?&gt;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> imAccount = map[ConvertUtil.IM_ACCOUNT]</span><br><span class="line">            <span class="keyword">if</span> (imAccount <span class="keyword">is</span> String) &#123;</span><br><span class="line">                RouterManager.goImUser(UserParams(imAccount), <span class="string">"ChatFragment"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>ç»“è®ºï¼š</strong><br>æ²¡å•¥å¥½çš„ï¼Œå°±æ˜¯æ›²æŠ˜å»å®ç°åˆ†ç¦»è€Œå·²ã€‚</p>
<p>vm è¿˜æœ‰é—´æ¥ä¾èµ–Viewã€‚<br>vmæŒæœ‰SpannableStringï¼Œ<br>SpannableStringæŒæœ‰ClickableSpanï¼Œ<br>ClickableSpanæŒæœ‰listenerï¼Œ<br>listeneræŒæœ‰fragmentã€‚<br>emmmmâ€¦.</p>
<p>ClickableSpanè®¾è®¡å°±æ˜¯è¿™æ ·ã€‚é‚£å°±æ¥äº†è§£äº†è§£å®ƒçš„å®ç°åŸç†å§ã€‚</p>
<h4 id="LinkMovementMethodï¼š"><a href="#LinkMovementMethodï¼š" class="headerlink" title="LinkMovementMethodï¼š"></a>LinkMovementMethodï¼š</h4><p>ClickableSpanæºç ä¹Ÿçœ‹äº†ï¼Œæ˜¾ç„¶å®ƒä¸æ˜¯ä¸»è¦å…³é”®ã€‚é‚£æ˜¯è°å»è°ƒç”¨ClickableSpançš„onClickæ–¹æ³•ï¼Œæ€ä¹ˆå†³å®šè°ƒç”¨æ—¶æœºå‘¢ï¼Ÿ</p>
<p>ClickableSpanæ–‡ä»¶å¤´ä»‹ç»ä¸­ï¼Œå·²ä¾›å‡ºä¸»è°‹æ˜¯LinkMovementMethodï¼ˆæ˜¯ä¸€ä¸ªå•ä¾‹ï¼‰ã€‚</p>
<p>ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç„¶ç¦»ä¸å¼€onTachçš„æ–¹æ³•ã€‚LinkMovementMethodé‡Œæ­£å¥½æœ‰ï¼Œé‚£å°±å†³å®šæ˜¯å®ƒäº†ã€‚<br><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public boolean onTouchEvent(TextView widget, Spannable <span class="keyword">buffer</span>,</span><br><span class="line">                                MotionEvent event) &#123;</span><br><span class="line">        <span class="type">int</span> action = event.getAction();</span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            <span class="type">int</span> x = (<span class="type">int</span>) event.getX();</span><br><span class="line">            <span class="type">int</span> y = (<span class="type">int</span>) event.getY();</span><br><span class="line">            x -= widget.getTotalPaddingLeft();</span><br><span class="line">            y -= widget.getTotalPaddingTop();</span><br><span class="line">            x += widget.getScrollX();</span><br><span class="line">            y += widget.getScrollY();</span><br><span class="line">            <span class="comment">// æ‰¾è§¦ç¢°çš„ä½ç½®ã€‚</span></span><br><span class="line">            Layout <span class="keyword">layout</span> = widget.getLayout();</span><br><span class="line">            <span class="comment">// ç¬¬å‡ è¡Œã€‚</span></span><br><span class="line">            <span class="type">int</span> line = <span class="keyword">layout</span>.getLineForVertical(y);</span><br><span class="line">            <span class="comment">// ç¬¬å‡ ä¸ªå­—ç¬¦ã€‚</span></span><br><span class="line">            <span class="type">int</span> off = <span class="keyword">layout</span>.getOffsetForHorizontal(line, x);</span><br><span class="line">            <span class="comment">// æ‰¾å‡ºè§¦æ‘¸åˆ°çš„æ–‡æœ¬ä¸­çš„ ClickableSpanã€‚</span></span><br><span class="line">            ClickableSpan[] links = <span class="keyword">buffer</span>.getSpans(off, off, ClickableSpan.class);</span><br><span class="line">            <span class="keyword">if</span> (links.<span class="built_in">length</span> != <span class="number">0</span>) &#123;</span><br><span class="line">                ClickableSpan link = links[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (action == MotionEvent.ACTION_UP) &#123;</span><br><span class="line">                    <span class="comment">// ä¸è®¤è¯†ï¼Œä¸ç®¡å®ƒã€‚</span></span><br><span class="line">                    <span class="keyword">if</span> (link instanceof TextLinkSpan) &#123;</span><br><span class="line">                        ((TextLinkSpan) link).onClick(</span><br><span class="line">                                widget, TextLinkSpan.INVOCATION_METHOD_TOUCH);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// æ‰‹æŒ‡æŠ¬èµ·æ—¶å›è°ƒonClickæ–¹æ³•ã€‚</span></span><br><span class="line">                        link.onClick(widget);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">                    <span class="comment">// æŒ‰ä¸‹è®¾ç½®ä¸€ä¸‹é€‰ä¸­æ ·å¼ã€‚ä¹Ÿå°±æ˜¯å…‰æ ‡ã€‚</span></span><br><span class="line">                    <span class="keyword">if</span> (widget.getContext().getApplicationInfo().targetSdkVersion</span><br><span class="line">                            &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">                        <span class="comment">// Selection change will reposition the toolbar. Hide it for a few ms for a</span></span><br><span class="line">                        <span class="comment">// smoother transition.</span></span><br><span class="line">                        widget.hideFloatingToolbar(HIDE_FLOATING_TOOLBAR_DELAY_MS);</span><br><span class="line">                    &#125;</span><br><span class="line">                    Selection.setSelection(<span class="keyword">buffer</span>,</span><br><span class="line">                            <span class="keyword">buffer</span>.getSpanStart(link),</span><br><span class="line">                            <span class="keyword">buffer</span>.getSpanEnd(link));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ¸…é™¤é€‰ä¸­æ ·å¼ã€‚ä¹Ÿå°±æ˜¯å…‰æ ‡ã€‚</span></span><br><span class="line">                Selection.removeSelection(<span class="keyword">buffer</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> super.onTouchEvent(widget, <span class="keyword">buffer</span>, event);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥LinkMovementMethodä¹Ÿæ˜¯æ ¹æ®è§¦æ‘¸çš„ä½ç½®æ‰¾å‡ºClickableSpanï¼ˆåŒä¸€ä¸ªä½ç½®è®¾ç½®å¤šä¸ªçš„è¯ï¼Œä¹Ÿåªä¼šæ‰§è¡Œç¬¬ä¸€ä¸ªï¼‰ï¼Œç„¶åå›è°ƒonClickã€‚<br>LinkMovementMethodæ˜¯è¢«TextViewå›è°ƒã€‚<br>çœ‹åˆ°è¿™é‡ŒClickableSpançš„å®ç°åŸç†åŸºæœ¬å°±æ¸…æ¥šäº†ã€‚</p>
<h5 id="å…¶ä»–æ–¹æ¡ˆ"><a href="#å…¶ä»–æ–¹æ¡ˆ" class="headerlink" title="å…¶ä»–æ–¹æ¡ˆ"></a>å…¶ä»–æ–¹æ¡ˆ</h5><p>æœ‰ä¸ªå¤§èƒ†çš„æƒ³æ³•ğŸ’¡ï¼š<br>æˆ‘å…ˆè‡ªå®šä¹‰åªå¸¦æ•°æ®å’Œæ ·å¼çš„spanã€‚å†å®šä¹‰ä¸€ä¸ª MySpanListener é‡Œé¢æœ‰ä¸ªæ–¹æ³•<code>onClick(v:View,data:Data)</code>ã€‚<br>ç„¶åè‡ªå®šä¹‰LinkMovementMethodï¼ˆæ¯”å¦‚å«MyMovementMethodï¼‰ã€‚åŒä¸Šåœ¨onTouchEventé‡Œæ‰¾å‡ºè‡ªå·±å®šä¹‰spanã€‚ç„¶åæ ¹æ®textViewæ‹¿åˆ°listenerã€‚å›è°ƒ<code>onClick(v:View,data:Data)</code>æ–¹æ³•ã€‚<br>é‚£ä¹ˆé—®é¢˜æ˜¯çº¢å­—çš„æ€ä¹ˆå»å®ç°ï¼ˆä¸»è¦é—®é¢˜æ˜¯listenerï¼Œä»¥ä»€ä¹ˆç»´åº¦å‚¨å­˜ï¼Œæ€ä¹ˆå‚¨å­˜ï¼‰ã€‚æ¯”å¦‚åœ¨MyMovementMethodé‡Œè®¾ç½®ä¸€ä¸ªå¼±å¼•ç”¨çš„mapï¼š<code>WeakHashMap&lt;TextView,MySpanListener&gt;</code></p>
<p>ä¹Ÿæ˜¯ä¸€ç§æ–¹æ³•ï¼Œä½†æ˜¯çœ‹èµ·æ¥æŒºåˆ«æ‰­ã€‚å“ˆã€‚ã€‚ã€‚</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3262738-99188fa15f6b462a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="é…ä¸€å¼ å›¾"></p>
<h4 id="å¦ä¸€ä¸ªé—®é¢˜"><a href="#å¦ä¸€ä¸ªé—®é¢˜" class="headerlink" title="å¦ä¸€ä¸ªé—®é¢˜"></a>å¦ä¸€ä¸ªé—®é¢˜</h4><p>LinkMovementMethodæœ‰ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå°±æ˜¯é•¿æŒ‰æ—¶ã€‚ä¾æ—§ä¼šå›è°ƒonClickæ–¹æ³•ã€‚è¿™å°±ä¼šå‡ºç°äº¤äº’ä¼¤çš„bugã€‚<br>è§£å†³æ–¹æ¡ˆï¼š<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> ClickLinkMovementMethod : LinkMovementMethod() &#123;</span><br><span class="line">    <span class="keyword">private</span> const <span class="keyword">val</span> CLICK_DELAY = <span class="number">500</span>L</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> lastClickTime: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(widget: <span class="type">TextView</span>?, buffer: <span class="type">Spannable</span>?, event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        event ?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        widget ?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">val</span> action = event.action</span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP ||</span><br><span class="line">                action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            <span class="keyword">var</span> x = event.x.toInt()</span><br><span class="line">            <span class="keyword">var</span> y = event.y.toInt()</span><br><span class="line">            x -= widget.totalPaddingLeft</span><br><span class="line">            y -= widget.totalPaddingTop</span><br><span class="line">            x += widget.scrollX</span><br><span class="line">            y += widget.scrollY</span><br><span class="line">            <span class="keyword">val</span> layout: Layout = widget.layout</span><br><span class="line">            <span class="keyword">val</span> line: <span class="built_in">Int</span> = layout.getLineForVertical(y)</span><br><span class="line">            <span class="keyword">val</span> off: <span class="built_in">Int</span> = layout.getOffsetForHorizontal(line, x.toFloat())</span><br><span class="line">            <span class="keyword">val</span> link: Array&lt;ClickableSpan&gt; = buffer?.getSpans(off, off, ClickableSpan::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">                    ?: <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            <span class="keyword">if</span> (link.isNotEmpty()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (action == MotionEvent.ACTION_UP) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (System.currentTimeMillis() - lastClickTime &lt; CLICK_DELAY) &#123;</span><br><span class="line">                        link[<span class="number">0</span>].onClick(widget)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">                    lastClickTime = System.currentTimeMillis()</span><br><span class="line">                    Selection.setSelection(buffer,</span><br><span class="line">                            buffer.getSpanStart(link[<span class="number">0</span>]),</span><br><span class="line">                            buffer.getSpanEnd(link[<span class="number">0</span>]))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Selection.removeSelection(buffer)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><ol>
<li>ClickableSpanå®ç°ç‚¹å‡»ç›‘å¬çš„åŸç†æ˜¯LinkMovementMethodã€‚</li>
<li>LinkMovementMethodå­˜åœ¨é•¿æŒ‰æ—¶äº¤äº’çš„bugã€‚</li>
<li>ClickableSpançš„æ•°æ®&amp;äº‹ä»¶åˆ†ç¦»ä¾æ—§æœŸæœ›æ›´ä¼˜è´¨çš„æ–¹æ¡ˆã€‚</li>
</ol>
</div><div class="post-copyright"><blockquote><p>åŸæ–‡ä½œè€…: wzmyyj</p><p>åŸæ–‡é“¾æ¥: <a href="https://wzmyyj.top/2020/05/12/android_5/">https://wzmyyj.top/2020/05/12/android_5/</a></p><p>ç‰ˆæƒå£°æ˜: è½¬è½½è¯·æ³¨æ˜å‡ºå¤„(å¿…é¡»ä¿ç•™ä½œè€…ç½²ååŠé“¾æ¥)</p></blockquote></div><div class="tags"><a href="/tags/android/">android</a></div><div class="post-share"><div class="social-share"><span>åˆ†äº«åˆ°:</span></div></div><div class="post-nav"><a href="/2020/05/12/android_6/" class="pre">TextViewè¯†åˆ«æ–‡æœ¬ä¸­çš„è¶…é“¾æ¥å¹¶èƒ½ç‚¹å‡»è·³è½¬</a><a href="/2020/05/11/android_4/" class="next">Fragment ç›‘å¬è¿”å›æŒ‰é”®</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">æ–‡ç« ç›®å½•</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ClickableSpan"><span class="toc-text">ClickableSpan</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#é‡åˆ°é—®é¢˜"><span class="toc-text">é‡åˆ°é—®é¢˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LinkMovementMethodï¼š"><span class="toc-text">LinkMovementMethodï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#å…¶ä»–æ–¹æ¡ˆ"><span class="toc-text">å…¶ä»–æ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å¦ä¸€ä¸ªé—®é¢˜"><span class="toc-text">å¦ä¸€ä¸ªé—®é¢˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ€»ç»“ï¼š"><span class="toc-text">æ€»ç»“ï¼š</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> æœ€æ–°æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/21/android_10/">IMä¸­ç¾¤æ¶ˆæ¯å‘é€è€…ä¿¡æ¯åˆ·æ–°æ–¹æ¡ˆ</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/21/android_9/">IMä¸­æŒ‰åç§°æ‹¼éŸ³å­—æ¯åˆ†ç»„æ’åº</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/21/android_8/">IMé¡¹ç›®ä¸­ç¾¤æˆå‘˜è·å–ä¸ç¼“å­˜ç­–ç•¥</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/20/story_2/">å°æ•…äº‹ï¼šæœªç†Ÿçš„æœå®</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/19/android_7/">IMé¡¹ç›®ä¸­çš„è‡ªå®šä¹‰å°è¡¨æƒ…å®ç°</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/android_6/">TextViewè¯†åˆ«æ–‡æœ¬ä¸­çš„è¶…é“¾æ¥å¹¶èƒ½ç‚¹å‡»è·³è½¬</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/android_5/">ClickableSpançš„ä¸€ç‚¹ç‚¹æ‘¸ç´¢</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/android_4/">Fragment ç›‘å¬è¿”å›æŒ‰é”®</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/10/android_3/">LiveDataå®ç°æ¶ˆæ¯æ€»çº¿</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/13/kotlin_1/">kotlinä½¿ç”¨letæŠ¥java.lang.NoClassDefFoundError</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/è®¾è®¡æ¨¡å¼/" style="font-size: 15px;">è®¾è®¡æ¨¡å¼</a> <a href="/tags/IT/" style="font-size: 15px;">IT</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/kotlin/" style="font-size: 15px;">kotlin</a> <a href="/tags/å›¾ç‰‡/" style="font-size: 15px;">å›¾ç‰‡</a> <a href="/tags/æ•…äº‹/" style="font-size: 15px;">æ•…äº‹</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> å½’æ¡£</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">16</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://shiyi.today/" title="ææ˜Šæ˜Šï¼šè¯—æ„" target="_blank">ææ˜Šæ˜Šï¼šè¯—æ„</a><ul></ul><a href="https://wangzeliangbsd.github.io/" title="ç‹äº®äº®ï¼šWZL Blog" target="_blank">ç‹äº®äº®ï¼šWZL Blog</a><ul></ul><a href="https://foreverlf.github.io/" title="æ–¹èƒ–å­ï¼šForeverLF" target="_blank">æ–¹èƒ–å­ï¼šForeverLF</a><ul></ul><a href="https://zqhgit.github.io/" title="æ›¾å°è¾‰ï¼šSprider" target="_blank">æ›¾å°è¾‰ï¼šSprider</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">ç½‘ç«™åœ°å›¾</a> |  <a href="/atom.xml">è®¢é˜…æœ¬ç«™</a> |  <a href="/about/">è”ç³»åšä¸»</a></p><p><span> Copyright &copy;<a href="/." rel="nofollow">wzmyyj.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"superSample":2,"width":100,"height":200,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":false,"scale":0.1},"react":{"opacityDefault":1,"opacityOnHover":0.2}});</script></body></html>